From 90faddd0ce9e521aac403f23f9d5d1bca25e0012 Mon Sep 17 00:00:00 2001
From: Kamil Trzcinski <ayufan@ayufan.eu>
Date: Sun, 6 Dec 2020 17:08:24 +0000
Subject: [PATCH] Use local paths

multiarch

dh-exec
---
 .cargo/config                        |  5 ---
 Cargo.toml                           | 11 ++---
 debian/control                       | 67 ----------------------------
 debian/proxmox-backup-server.install |  9 ++--
 debian/rules                         |  3 +-
 www/OnlineHelpInfo.js                |  4 +-
 6 files changed, 15 insertions(+), 84 deletions(-)
 delete mode 100644 .cargo/config
 mode change 100644 => 100755 debian/proxmox-backup-server.install

diff --git a/.cargo/config b/.cargo/config
deleted file mode 100644
index 3b5b6e48..00000000
--- a/.cargo/config
+++ /dev/null
@@ -1,5 +0,0 @@
-[source]
-[source.debian-packages]
-directory = "/usr/share/cargo/registry"
-[source.crates-io]
-replace-with = "debian-packages"
diff --git a/Cargo.toml b/Cargo.toml
index 283453e7..738c8c6e 100644
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -48,12 +48,13 @@ percent-encoding = "2.1"
 pin-utils = "0.1.0"
 pin-project = "0.4"
 pathpatterns = "0.1.2"
-proxmox = { version = "0.7.2", features = [ "sortable-macro", "api-macro", "websocket" ] }
+#proxmox = { version = "0.7.2", features = [ "sortable-macro", "api-macro", "websocket" ] }
 #proxmox = { git = "git://git.proxmox.com/git/proxmox", version = "0.1.2", features = [ "sortable-macro", "api-macro" ] }
-#proxmox = { path = "../proxmox/proxmox", features = [ "sortable-macro", "api-macro", "websocket" ] }
-proxmox-fuse = "0.1.0"
-pxar = { version = "0.6.1", features = [ "tokio-io", "futures-io" ] }
-#pxar = { path = "../pxar", features = [ "tokio-io", "futures-io" ] }
+proxmox = { path = "../proxmox/proxmox", features = [ "sortable-macro", "api-macro", "websocket" ] }
+#proxmox-fuse = "0.1.0"
+proxmox-fuse = { path = "../proxmox-fuse" }
+#pxar = { version = "0.6.1", features = [ "tokio-io", "futures-io" ] }
+pxar = { path = "../pxar", features = [ "tokio-io", "futures-io" ] }
 regex = "1.2"
 rustyline = "6"
 serde = { version = "1.0", features = ["derive"] }
diff --git a/debian/control b/debian/control
index 3eb37f0d..633cf97e 100644
--- a/debian/control
+++ b/debian/control
@@ -6,73 +6,6 @@ Build-Depends: debhelper (>= 11),
  cargo:native,
  rustc:native,
  libstd-rust-dev,
- librust-anyhow-1+default-dev,
- librust-apt-pkg-native-0.3+default-dev (>= 0.3.1-~~),
- librust-base64-0.12+default-dev,
- librust-bitflags-1+default-dev (>= 1.2.1-~~),
- librust-bytes-0.5+default-dev,
- librust-crc32fast-1+default-dev,
- librust-crossbeam-channel-0.4+default-dev,
- librust-endian-trait-0.6+arrays-dev,
- librust-endian-trait-0.6+default-dev,
- librust-futures-0.3+default-dev,
- librust-h2-0.2+default-dev,
- librust-h2-0.2+stream-dev,
- librust-handlebars-3+default-dev,
- librust-http-0.2+default-dev,
- librust-hyper-0.13+default-dev (>= 0.13.6-~~),
- librust-lazy-static-1+default-dev (>= 1.4-~~),
- librust-libc-0.2+default-dev,
- librust-log-0.4+default-dev,
- librust-nix-0.19+default-dev,
- librust-nom-5+default-dev (>= 5.1-~~),
- librust-num-traits-0.2+default-dev,
- librust-once-cell-1+default-dev (>= 1.3.1-~~),
- librust-openssl-0.10+default-dev,
- librust-pam-0.7+default-dev,
- librust-pam-sys-0.5+default-dev,
- librust-pathpatterns-0.1+default-dev (>= 0.1.2-~~),
- librust-percent-encoding-2+default-dev (>= 2.1-~~),
- librust-pin-project-0.4+default-dev,
- librust-pin-utils-0.1+default-dev,
- librust-proxmox-0.7+api-macro-dev (>= 0.7.2-~~),
- librust-proxmox-0.7+default-dev (>= 0.7.2-~~),
- librust-proxmox-0.7+sortable-macro-dev (>= 0.7.2-~~),
- librust-proxmox-0.7+websocket-dev (>= 0.7.2-~~),
- librust-proxmox-fuse-0.1+default-dev,
- librust-pxar-0.6+default-dev (>= 0.6.1-~~),
- librust-pxar-0.6+futures-io-dev (>= 0.6.1-~~),
- librust-pxar-0.6+tokio-io-dev (>= 0.6.1-~~),
- librust-regex-1+default-dev (>= 1.2-~~),
- librust-rustyline-6+default-dev,
- librust-serde-1+default-dev,
- librust-serde-1+derive-dev,
- librust-serde-json-1+default-dev,
- librust-siphasher-0.3+default-dev,
- librust-syslog-4+default-dev,
- librust-tokio-0.2+blocking-dev (>= 0.2.9-~~),
- librust-tokio-0.2+default-dev (>= 0.2.9-~~),
- librust-tokio-0.2+dns-dev (>= 0.2.9-~~),
- librust-tokio-0.2+fs-dev (>= 0.2.9-~~),
- librust-tokio-0.2+io-util-dev (>= 0.2.9-~~),
- librust-tokio-0.2+macros-dev (>= 0.2.9-~~),
- librust-tokio-0.2+process-dev (>= 0.2.9-~~),
- librust-tokio-0.2+rt-threaded-dev (>= 0.2.9-~~),
- librust-tokio-0.2+signal-dev (>= 0.2.9-~~),
- librust-tokio-0.2+stream-dev (>= 0.2.9-~~),
- librust-tokio-0.2+tcp-dev (>= 0.2.9-~~),
- librust-tokio-0.2+time-dev (>= 0.2.9-~~),
- librust-tokio-0.2+uds-dev (>= 0.2.9-~~),
- librust-tokio-openssl-0.4+default-dev,
- librust-tokio-util-0.3+codec-dev,
- librust-tokio-util-0.3+default-dev,
- librust-tower-service-0.3+default-dev,
- librust-udev-0.4+default-dev | librust-udev-0.3+default-dev,
- librust-url-2+default-dev (>= 2.1-~~),
- librust-walkdir-2+default-dev,
- librust-xdg-2+default-dev (>= 2.2-~~),
- librust-zstd-0.4+bindgen-dev,
- librust-zstd-0.4+default-dev,
  libacl1-dev,
  libfuse3-dev,
  libsystemd-dev,
diff --git a/debian/proxmox-backup-server.install b/debian/proxmox-backup-server.install
old mode 100644
new mode 100755
index d79553ec..9f5841a8
--- a/debian/proxmox-backup-server.install
+++ b/debian/proxmox-backup-server.install
@@ -1,13 +1,14 @@
+#! /usr/bin/dh-exec
 etc/proxmox-backup-proxy.service /lib/systemd/system/
 etc/proxmox-backup.service /lib/systemd/system/
 etc/proxmox-backup-banner.service /lib/systemd/system/
 etc/proxmox-backup-daily-update.service /lib/systemd/system/
 etc/proxmox-backup-daily-update.timer /lib/systemd/system/
 etc/pbs-enterprise.list /etc/apt/sources.list.d/
-usr/lib/x86_64-linux-gnu/proxmox-backup/proxmox-backup-api
-usr/lib/x86_64-linux-gnu/proxmox-backup/proxmox-backup-proxy
-usr/lib/x86_64-linux-gnu/proxmox-backup/proxmox-backup-banner
-usr/lib/x86_64-linux-gnu/proxmox-backup/proxmox-daily-update
+usr/lib/${DEB_HOST_MULTIARCH}/proxmox-backup/proxmox-backup-api
+usr/lib/${DEB_HOST_MULTIARCH}/proxmox-backup/proxmox-backup-proxy
+usr/lib/${DEB_HOST_MULTIARCH}/proxmox-backup/proxmox-backup-banner
+usr/lib/${DEB_HOST_MULTIARCH}/proxmox-backup/proxmox-daily-update
 usr/sbin/proxmox-backup-manager
 usr/share/javascript/proxmox-backup/index.hbs
 usr/share/javascript/proxmox-backup/css/ext6-pbs.css
diff --git a/debian/rules b/debian/rules
index 2bc0f694..83889ac5 100755
--- a/debian/rules
+++ b/debian/rules
@@ -2,6 +2,7 @@
 # See debhelper(7) (uncomment to enable)
 # output every command that modifies files on the build system.
 DH_VERBOSE = 1
+DEB_HOST_MULTIARCH ?= $(shell dpkg-architecture -qDEB_HOST_MULTIARCH) 
 
 include /usr/share/dpkg/pkg-info.mk
 include /usr/share/rustc/architecture.mk
@@ -21,7 +22,7 @@ export DEB_CARGO_PACKAGE=proxmox-backup
 	dh $@ --with=bash-completion
 
 override_dh_auto_configure:
-	$(CARGO) prepare-debian $(CURDIR)/debian/cargo_registry --link-from-system
+	#$(CARGO) prepare-debian --help $(CURDIR)/debian/cargo_registry --link-from-system
 	dh_auto_configure
 
 override_dh_auto_build:
diff --git a/www/OnlineHelpInfo.js b/www/OnlineHelpInfo.js
index c54912d8..f2521c4b 100644
--- a/www/OnlineHelpInfo.js
+++ b/www/OnlineHelpInfo.js
@@ -19,8 +19,8 @@ const proxmoxOnlineHelpInfo = {
     "link": "/docs/backup-client.html#backup-pruning",
     "title": "Pruning and Removing Backups"
   },
-  "id3": {
-    "link": "/docs/backup-client.html#id3",
+  "id4": {
+    "link": "/docs/backup-client.html#id4",
     "title": "Garbage Collection"
   },
   "pxar-format": {
-- 
2.20.1

